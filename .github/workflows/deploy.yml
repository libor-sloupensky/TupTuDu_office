name: Deploy via SFTP

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - uses: actions/checkout@v3

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.4'
        extensions: mbstring, xml, curl, zip, openssl

    - name: Install Composer dependencies
      run: composer install --no-dev --optimize-autoloader --no-interaction

    - name: Generate last push timestamp
      run: echo "$(TZ='Europe/Prague' date '+%d.%m.%Y %H:%M:%S')" > ./public/last_push.txt

    - name: Prepare deploy structure
      run: |
        mkdir -p deploy/public_html
        # Copy Laravel core to deploy root
        cp -r app bootstrap config database resources routes storage vendor deploy/
        cp artisan composer.json composer.lock deploy/
        # Copy public files to public_html
        cp -r public/. deploy/public_html/
        # Create storage directories
        mkdir -p deploy/storage/framework/sessions
        mkdir -p deploy/storage/framework/views
        mkdir -p deploy/storage/framework/cache/data
        mkdir -p deploy/storage/app/private/invoices

    - name: Deploy via lftp
      run: |
        sudo apt-get install -y lftp
        lftp -e "
          set sftp:connect-program 'ssh -o StrictHostKeyChecking=no -p 222';
          open sftp://libor.tuptudu.cz:${{ secrets.FTP_PASSWORD }}@ftp.tuptudu.cz;
          mirror --reverse --parallel=5 --verbose deploy/ /;
          quit
        "
